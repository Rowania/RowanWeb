# 数据库迁移 (Migrations)

## 概述

`migration` 目录包含了博客项目的数据库 schema 变更脚本。我使用 **SeaORM 的迁移工具** 来管理数据库版本。

---

## 数据库设计概览

你的博客项目数据库设计简洁高效，主要包含以下核心表格，它们共同支撑了博客的各项功能：

### notes_metadata

**用途**: 存储博客文章的结构化信息，如标题、摘要、发布时间、阅读量和点赞数。文章的实际内容存储在文件系统中，此表只存储其元数据。

**关键点**:

- `likes_count` 字段直接存储了文章的点赞总数，方便快速读取。

---

### comments (评论表)

**用途**: 存储用户在文章下的留言内容。

**关键点**:

- **匿名评论**: 用户无需登录即可评论。
- **昵称绑定**: 通过 `visitor_profile_id` 关联到 `visitor_profiles` 表，每次显示评论时都会从 `visitor_profiles` 获取评论者当前最新的昵称。这意味着如果访客更改了昵称，其所有历史评论的昵称也会随之更新。
- **支持嵌套回复**: 使用 `parent_id` 字段实现嵌套回复。

---

### likes (点赞记录表)

**用途**: 记录每篇笔记的点赞行为，最主要用于限制重复点赞。

**关键点**:

- **完全匿名**: 不存储任何用户身份信息（如 `visitor_profile_id`），也不存储点赞时间。
- **防重复机制**: 包含 `note_metadata_id` 和 `ip_address` 字段，并通过这两个字段的联合唯一约束来防止同一个 IP 地址对同一篇文章重复点赞。
- **不统计数量**: 该表不直接提供点赞总数，点赞总数存储在 `notes_metadata` 表的 `likes_count` 字段中。

---

### friends_links (友链表)

**用途**: 存储你的博客友情链接信息。

**关键点**:

- 字段长度根据实际需求做了优化，例如:
  - `name` (100 字符)
  - `url` (500 字符)
  - `description` (255 字符)
  - `logo_url` (500 字符)
- 所有时间戳都采用 UTC 时区。

---

### visitor_profiles (访客偏好表)

**用途**: 存储匿名访客的长期偏好设置，主要是将浏览器的 Cookie ID 与访客的昵称进行绑定。

**关键点**:

- `cookie_id` 使用 UUID 格式，长度限制为 40 且唯一。
- 存储访客选择的昵称 (`nickname`)，不要求唯一。
- 包含 `ip_address` 字段作为辅助信息，但不再作为绑定昵称的主要依据。
